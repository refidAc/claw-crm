// Prisma schema for CRM monorepo
// Multi-tenant: every tenant-scoped model has accountId
// Soft deletes via deletedAt on key models

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────
// TENANCY
// ─────────────────────────────────────────────

model Account {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  plan      String   @default("free")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users               User[]
  roles               Role[]
  contacts            Contact[]
  companies           Company[]
  pipelines           Pipeline[]
  opportunities       Opportunity[]
  conversations       Conversation[]
  channelIdentities   ChannelIdentity[]
  tasks               Task[]
  notes               Note[]
  activityEvents      ActivityEvent[]
  workflowDefinitions WorkflowDefinition[]
  jobs                Job[]
}

// ─────────────────────────────────────────────
// AUTH / RBAC
// ─────────────────────────────────────────────

model User {
  id             String    @id @default(cuid())
  accountId      String
  email          String
  name           String
  hashedPassword String
  role           String    @default("member")
  createdAt      DateTime  @default(now())
  deletedAt      DateTime?

  account         Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  assignedTasks   Task[]        @relation("AssignedUser")
  authoredNotes   Note[]        @relation("NoteAuthor")
  sessions        Session[]

  @@unique([accountId, email])
  @@index([accountId])
  @@index([email])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Role {
  id          String       @id @default(cuid())
  accountId   String
  name        String
  permissions Permission[]

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, name])
  @@index([accountId])
}

model Permission {
  id       String @id @default(cuid())
  roleId   String
  resource String
  action   String

  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, resource, action])
  @@index([roleId])
}

// ─────────────────────────────────────────────
// CRM CORE
// ─────────────────────────────────────────────

model Company {
  id        String    @id @default(cuid())
  accountId String
  name      String
  domain    String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  contacts Contact[]

  @@index([accountId])
}

model Contact {
  id        String    @id @default(cuid())
  accountId String
  firstName String
  lastName  String
  email     String?
  phone     String?
  companyId String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  account           Account           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  company           Company?          @relation(fields: [companyId], references: [id])
  opportunities     Opportunity[]
  conversations     Conversation[]
  channelIdentities ChannelIdentity[]
  tasks             Task[]
  notes             Note[]

  @@index([accountId])
  @@index([email])
  @@index([companyId])
}

// ─────────────────────────────────────────────
// PIPELINE / DEALS
// ─────────────────────────────────────────────

model Pipeline {
  id        String   @id @default(cuid())
  accountId String
  name      String
  createdAt DateTime @default(now())

  account       Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  stages        Stage[]
  opportunities Opportunity[]

  @@index([accountId])
}

model Stage {
  id         String  @id @default(cuid())
  pipelineId String
  name       String
  order      Int
  color      String  @default("#6366f1")

  pipeline      Pipeline      @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  opportunities Opportunity[]

  @@index([pipelineId])
}

model Opportunity {
  id         String    @id @default(cuid())
  accountId  String
  contactId  String
  pipelineId String
  stageId    String
  title      String
  value      Decimal?  @db.Decimal(12, 2)
  status     String    @default("open")
  closedAt   DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  account  Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  contact  Contact  @relation(fields: [contactId], references: [id])
  pipeline Pipeline @relation(fields: [pipelineId], references: [id])
  stage    Stage    @relation(fields: [stageId], references: [id])
  tasks    Task[]
  notes    Note[]

  @@index([accountId])
  @@index([contactId])
  @@index([pipelineId])
  @@index([stageId])
}

// ─────────────────────────────────────────────
// MESSAGING
// ─────────────────────────────────────────────

model Conversation {
  id          String    @id @default(cuid())
  accountId   String
  contactId   String
  subject     String?
  status      String    @default("open")
  channelType String?   // primary channel: email | sms | whatsapp | etc.
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  contact  Contact   @relation(fields: [contactId], references: [id])
  messages Message[]

  @@index([accountId])
  @@index([contactId])
}

model Message {
  id             String    @id @default(cuid())
  conversationId String
  direction      String    // inbound | outbound
  channel        String    // email | sms | whatsapp | etc.
  body           String
  status         String    @default("queued") // queued | sent | delivered | failed | read
  sentAt         DateTime?
  readAt         DateTime? // set when status transitions to 'read'
  createdAt      DateTime  @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model ChannelIdentity {
  id        String  @id @default(cuid())
  accountId String
  contactId String
  type      String
  value     String
  isPrimary Boolean @default(false)

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([accountId, type, value])
  @@index([accountId])
  @@index([contactId])
}

// ─────────────────────────────────────────────
// TASKS & NOTES
// ─────────────────────────────────────────────

model Task {
  id             String    @id @default(cuid())
  accountId      String
  contactId      String?
  opportunityId  String?
  title          String
  dueAt          DateTime?
  completedAt    DateTime?
  assignedUserId String?

  account      Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  contact      Contact?     @relation(fields: [contactId], references: [id])
  opportunity  Opportunity? @relation(fields: [opportunityId], references: [id])
  assignedUser User?        @relation("AssignedUser", fields: [assignedUserId], references: [id])

  @@index([accountId])
  @@index([contactId])
  @@index([opportunityId])
  @@index([assignedUserId])
}

model Note {
  id            String   @id @default(cuid())
  accountId     String
  contactId     String?
  opportunityId String?
  body          String
  createdAt     DateTime @default(now())
  authorId      String

  account     Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  contact     Contact?     @relation(fields: [contactId], references: [id])
  opportunity Opportunity? @relation(fields: [opportunityId], references: [id])
  author      User         @relation("NoteAuthor", fields: [authorId], references: [id])

  @@index([accountId])
  @@index([contactId])
  @@index([opportunityId])
}

// ─────────────────────────────────────────────
// ACTIVITY LOG
// ─────────────────────────────────────────────

model ActivityEvent {
  id         String   @id @default(cuid())
  accountId  String
  entityType String
  entityId   String
  eventType  String
  payload    Json     @default("{}")
  createdAt  DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([entityType, entityId])
}

// ─────────────────────────────────────────────
// WORKFLOWS / AUTOMATION
// ─────────────────────────────────────────────

model WorkflowDefinition {
  id          String    @id @default(cuid())
  accountId   String
  name        String
  description String?
  isActive    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  account    Account    @relation(fields: [accountId], references: [id], onDelete: Cascade)
  triggers   Trigger[]
  actions    Action[]
  conditions Condition[]
  delays     Delay[]
  jobs       Job[]

  @@index([accountId])
}

model Trigger {
  id         String @id @default(cuid())
  workflowId String
  eventType  String
  filters    Json   @default("{}")

  workflow WorkflowDefinition @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
}

model Action {
  id         String @id @default(cuid())
  workflowId String
  order      Int
  type       String
  config     Json   @default("{}")

  workflow   WorkflowDefinition @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  conditions Condition[]
  delays     Delay[]

  @@index([workflowId])
}

model Condition {
  id         String @id @default(cuid())
  workflowId String
  actionId   String
  expression String

  workflow WorkflowDefinition @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  action   Action             @relation(fields: [actionId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([actionId])
}

model Delay {
  id          String @id @default(cuid())
  workflowId  String
  actionId    String
  delayType   String
  delayValue  Int

  workflow WorkflowDefinition @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  action   Action             @relation(fields: [actionId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([actionId])
}

// ─────────────────────────────────────────────
// JOBS / QUEUE
// ─────────────────────────────────────────────

model Job {
  id          String    @id @default(cuid())
  accountId   String
  workflowId  String?
  type        String
  payload     Json      @default("{}")
  status      String    @default("pending")
  scheduledAt DateTime?
  createdAt   DateTime  @default(now())

  account  Account             @relation(fields: [accountId], references: [id], onDelete: Cascade)
  workflow WorkflowDefinition? @relation(fields: [workflowId], references: [id])
  runs     JobRun[]

  @@index([accountId])
  @@index([status])
  @@index([workflowId])
}

model JobRun {
  id          String    @id @default(cuid())
  jobId       String
  attempt     Int       @default(1)
  status      String
  result      Json?
  error       String?
  startedAt   DateTime?
  finishedAt  DateTime?

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
}
